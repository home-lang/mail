openapi: 3.0.3
info:
  title: SMTP Server REST API
  description: |
    REST API for managing the Zig SMTP server. Provides endpoints for user management,
    server monitoring, message queue inspection, filtering rules, audit logs, and more.

    ## Authentication
    Most endpoints require CSRF token validation for state-changing operations (POST, PUT, DELETE).
    Obtain a CSRF token via `GET /api/csrf-token` and include it in the `X-CSRF-Token` header.

    ## GraphQL Alternative
    A GraphQL API is also available at `/api/graphql` for user management operations.
  version: 0.29.0
  contact:
    name: SMTP Server Support
  license:
    name: MIT
    url: https://opensource.org/licenses/MIT

servers:
  - url: http://localhost:8080
    description: API Server (default port)
  - url: http://localhost:8081
    description: Health Server (metrics and health checks)

tags:
  - name: Users
    description: User management operations
  - name: Authentication
    description: CSRF token and authentication
  - name: Password Reset
    description: Secure password reset functionality
  - name: Queue
    description: Message queue management
  - name: Filters
    description: Email filtering rules
  - name: Search
    description: Message search functionality
  - name: Configuration
    description: Server configuration
  - name: Logs
    description: Server logs
  - name: Audit
    description: Audit trail for administrative actions
  - name: Health
    description: Health checks and metrics
  - name: Statistics
    description: Server statistics
  - name: GraphQL
    description: GraphQL API endpoint
  - name: Tenants
    description: Multi-tenancy management
  - name: Archive
    description: Email archiving and compliance

paths:
  /api/csrf-token:
    get:
      tags:
        - Authentication
      summary: Get CSRF token
      description: Generates a new CSRF token for use in state-changing requests. Tokens are single-use and expire after 1 hour.
      operationId: getCSRFToken
      responses:
        '200':
          description: CSRF token generated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CSRFTokenResponse'

  /api/users:
    get:
      tags:
        - Users
      summary: List all users
      description: Returns a list of all registered users with their details.
      operationId: listUsers
      responses:
        '200':
          description: List of users retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserListResponse'

    post:
      tags:
        - Users
      summary: Create a new user
      description: Creates a new user account with the specified credentials.
      operationId: createUser
      security:
        - csrfToken: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateUserRequest'
      responses:
        '201':
          description: User created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CreateUserResponse'
        '400':
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '403':
          description: Invalid or missing CSRF token
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '409':
          description: User already exists
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/users/{username}:
    get:
      tags:
        - Users
      summary: Get a specific user
      description: Returns details for a single user by username.
      operationId: getUser
      parameters:
        - name: username
          in: path
          required: true
          description: The username to retrieve
          schema:
            type: string
            minLength: 3
            maxLength: 64
            pattern: '^[a-zA-Z0-9._-]+$'
      responses:
        '200':
          description: User details retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/User'
        '400':
          description: Invalid username format
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: User not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

    put:
      tags:
        - Users
      summary: Update a user
      description: Updates user properties such as email, password, or enabled status.
      operationId: updateUser
      security:
        - csrfToken: []
      parameters:
        - name: username
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateUserRequest'
      responses:
        '200':
          description: User updated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MessageResponse'
        '400':
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '403':
          description: Invalid or missing CSRF token
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: User not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

    delete:
      tags:
        - Users
      summary: Delete a user
      description: Permanently deletes a user account.
      operationId: deleteUser
      security:
        - csrfToken: []
      parameters:
        - name: username
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: User deleted successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MessageResponse'
        '403':
          description: Invalid or missing CSRF token
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: User not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/password-reset/request:
    post:
      tags:
        - Password Reset
      summary: Request password reset
      description: |
        Initiates a password reset for the specified username.
        Returns the same response whether the user exists or not (security measure).
        In production, the token would be sent via email.
      operationId: requestPasswordReset
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [username]
              properties:
                username:
                  type: string
                  description: Username to reset password for
      responses:
        '200':
          description: Reset request processed (same response for existing/non-existing users)
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                  token:
                    type: string
                    description: Reset token (development only - sent via email in production)
                  expires_in:
                    type: integer
                    description: Token expiry in seconds

  /api/password-reset/verify:
    post:
      tags:
        - Password Reset
      summary: Verify reset token
      description: Verifies that a password reset token is valid and not expired.
      operationId: verifyPasswordResetToken
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [token]
              properties:
                token:
                  type: string
                  description: The reset token to verify
      responses:
        '200':
          description: Token is valid
          content:
            application/json:
              schema:
                type: object
                properties:
                  valid:
                    type: boolean
                  username:
                    type: string
                  expires_in:
                    type: integer
        '400':
          description: Token is invalid, expired, or already used
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/password-reset/complete:
    post:
      tags:
        - Password Reset
      summary: Complete password reset
      description: Completes the password reset by setting a new password using the reset token.
      operationId: completePasswordReset
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [token, new_password]
              properties:
                token:
                  type: string
                  description: The reset token
                new_password:
                  type: string
                  minLength: 8
                  description: New password (minimum 8 characters)
      responses:
        '200':
          description: Password reset successful
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                  username:
                    type: string
        '400':
          description: Token is invalid, expired, or password too short
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/stats:
    get:
      tags:
        - Statistics
      summary: Get server statistics
      description: Returns overall server statistics including queue status and user counts.
      operationId: getStats
      responses:
        '200':
          description: Statistics retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/StatsResponse'

  /api/queue:
    get:
      tags:
        - Queue
      summary: Get message queue status
      description: Returns the current status of the message delivery queue.
      operationId: getQueue
      responses:
        '200':
          description: Queue status retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/QueueStatus'

  /api/filters:
    get:
      tags:
        - Filters
      summary: List all filters
      description: Returns all configured email filtering rules.
      operationId: listFilters
      responses:
        '200':
          description: Filters retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/FilterListResponse'

    post:
      tags:
        - Filters
      summary: Create a new filter
      description: Creates a new email filtering rule.
      operationId: createFilter
      security:
        - csrfToken: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateFilterRequest'
      responses:
        '201':
          description: Filter created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MessageResponse'
        '400':
          description: Invalid filter configuration
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '403':
          description: Invalid or missing CSRF token
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/filters/{filterId}:
    delete:
      tags:
        - Filters
      summary: Delete a filter
      description: Deletes an email filtering rule by ID.
      operationId: deleteFilter
      security:
        - csrfToken: []
      parameters:
        - name: filterId
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Filter deleted successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MessageResponse'
        '403':
          description: Invalid or missing CSRF token
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Filter not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/search:
    get:
      tags:
        - Search
      summary: Search messages
      description: Performs full-text search across email messages using FTS5.
      operationId: searchMessages
      parameters:
        - name: q
          in: query
          required: true
          description: Search query string
          schema:
            type: string
        - name: email
          in: query
          description: Filter by email address
          schema:
            type: string
        - name: folder
          in: query
          description: Filter by folder name
          schema:
            type: string
        - name: limit
          in: query
          description: Maximum number of results (default 100, max 1000)
          schema:
            type: integer
            default: 100
            maximum: 1000
        - name: offset
          in: query
          description: Number of results to skip for pagination
          schema:
            type: integer
            default: 0
        - name: from_date
          in: query
          description: Filter messages after this Unix timestamp
          schema:
            type: integer
            format: int64
        - name: to_date
          in: query
          description: Filter messages before this Unix timestamp
          schema:
            type: integer
            format: int64
        - name: attachments
          in: query
          description: Filter for messages with attachments
          schema:
            type: boolean
      responses:
        '200':
          description: Search results returned successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SearchResponse'
        '400':
          description: Missing query parameter
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '503':
          description: Search functionality not enabled
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/search/stats:
    get:
      tags:
        - Search
      summary: Get search statistics
      description: Returns statistics about the search index.
      operationId: getSearchStats
      responses:
        '200':
          description: Search statistics retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SearchStats'
        '503':
          description: Search functionality not enabled
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/search/rebuild:
    post:
      tags:
        - Search
      summary: Rebuild search index
      description: Triggers a rebuild of the full-text search index.
      operationId: rebuildSearchIndex
      security:
        - csrfToken: []
      responses:
        '200':
          description: Search index rebuilt successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MessageResponse'
        '403':
          description: Invalid or missing CSRF token
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Failed to rebuild index
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '503':
          description: Search functionality not enabled
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/config:
    get:
      tags:
        - Configuration
      summary: Get server configuration
      description: Returns current server configuration from environment variables.
      operationId: getConfig
      responses:
        '200':
          description: Configuration retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ConfigResponse'

    put:
      tags:
        - Configuration
      summary: Update server configuration
      description: Updates server configuration. Note that changes require a server restart to take effect.
      operationId: updateConfig
      security:
        - csrfToken: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              additionalProperties:
                type: string
      responses:
        '200':
          description: Configuration update received
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MessageResponse'
        '403':
          description: Invalid or missing CSRF token
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/logs:
    get:
      tags:
        - Logs
      summary: Get server logs
      description: Returns recent server log entries with optional filtering.
      operationId: getLogs
      parameters:
        - name: limit
          in: query
          description: Maximum number of log lines (default 100, max 1000)
          schema:
            type: integer
            default: 100
            maximum: 1000
        - name: level
          in: query
          description: Filter by log level
          schema:
            type: string
            enum: [DEBUG, INFO, WARN, ERROR]
      responses:
        '200':
          description: Logs retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/LogsResponse'
        '404':
          description: Log file not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/audit:
    get:
      tags:
        - Audit
      summary: Query audit log
      description: Returns audit trail entries for administrative actions with filtering and pagination.
      operationId: getAuditLog
      parameters:
        - name: action
          in: query
          description: Filter by action type
          schema:
            type: string
            enum:
              - USER_CREATED
              - USER_UPDATED
              - USER_DELETED
              - USER_ENABLED
              - USER_DISABLED
              - PASSWORD_CHANGED
              - LOGIN_SUCCESS
              - LOGIN_FAILED
              - LOGOUT
              - SESSION_EXPIRED
              - CONFIG_UPDATED
              - CONFIG_RELOADED
              - RATE_LIMIT_TRIGGERED
              - ACCESS_DENIED
              - PERMISSION_CHANGED
              - SERVER_STARTED
              - SERVER_STOPPED
              - BACKUP_CREATED
              - BACKUP_RESTORED
              - MESSAGE_SENT
              - MESSAGE_DELETED
              - MESSAGE_QUARANTINED
        - name: actor
          in: query
          description: Filter by actor (user or system)
          schema:
            type: string
        - name: severity
          in: query
          description: Filter by severity level
          schema:
            type: string
            enum: [INFO, WARNING, IMPORTANT, CRITICAL]
        - name: limit
          in: query
          description: Maximum entries to return (default 100, max 1000)
          schema:
            type: integer
            default: 100
            maximum: 1000
        - name: offset
          in: query
          description: Number of entries to skip for pagination
          schema:
            type: integer
            default: 0
      responses:
        '200':
          description: Audit entries retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuditResponse'
        '500':
          description: Failed to query audit log
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/graphql:
    post:
      tags:
        - GraphQL
      summary: GraphQL endpoint
      description: |
        Execute GraphQL queries and mutations for user management.

        **Queries:** users, user(username)
        **Mutations:** createUser, updateUser, deleteUser, changePassword, setUserEnabled
      operationId: graphql
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/GraphQLRequest'
      responses:
        '200':
          description: GraphQL response
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GraphQLResponse'

  /health:
    get:
      tags:
        - Health
      summary: Health check
      description: Returns the health status of the server including dependency checks. Runs on health server port (default 8081).
      operationId: healthCheck
      servers:
        - url: http://localhost:8081
      responses:
        '200':
          description: Server is healthy
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthResponse'
        '503':
          description: Server is unhealthy
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthResponse'

  /metrics:
    get:
      tags:
        - Health
      summary: Prometheus metrics
      description: Returns server metrics in Prometheus text format. Runs on health server port (default 8081).
      operationId: getMetrics
      servers:
        - url: http://localhost:8081
      responses:
        '200':
          description: Metrics in Prometheus format
          content:
            text/plain:
              schema:
                type: string

  /:
    get:
      tags:
        - Administration
      summary: Admin dashboard
      description: Serves the web-based administration interface.
      operationId: adminDashboard
      responses:
        '200':
          description: HTML admin interface
          content:
            text/html:
              schema:
                type: string

  /admin:
    get:
      tags:
        - Administration
      summary: Admin dashboard (alias)
      description: Alias for the admin dashboard.
      operationId: adminDashboardAlias
      responses:
        '200':
          description: HTML admin interface
          content:
            text/html:
              schema:
                type: string

  # Multi-tenancy Endpoints
  /api/tenants:
    get:
      tags:
        - Tenants
      summary: List all tenants
      description: Returns a list of all configured tenants with their settings.
      operationId: listTenants
      responses:
        '200':
          description: Tenant list retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TenantListResponse'

    post:
      tags:
        - Tenants
      summary: Create a new tenant
      description: Creates a new tenant with the specified configuration.
      operationId: createTenant
      security:
        - csrfToken: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateTenantRequest'
      responses:
        '201':
          description: Tenant created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Tenant'
        '400':
          description: Invalid tenant configuration
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '409':
          description: Tenant already exists
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/tenants/{tenantId}:
    get:
      tags:
        - Tenants
      summary: Get tenant details
      description: Returns detailed information for a specific tenant.
      operationId: getTenant
      parameters:
        - name: tenantId
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Tenant details retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Tenant'
        '404':
          description: Tenant not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

    put:
      tags:
        - Tenants
      summary: Update tenant
      description: Updates tenant configuration.
      operationId: updateTenant
      security:
        - csrfToken: []
      parameters:
        - name: tenantId
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateTenantRequest'
      responses:
        '200':
          description: Tenant updated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Tenant'
        '404':
          description: Tenant not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

    delete:
      tags:
        - Tenants
      summary: Delete tenant
      description: Deletes a tenant and optionally all associated data.
      operationId: deleteTenant
      security:
        - csrfToken: []
      parameters:
        - name: tenantId
          in: path
          required: true
          schema:
            type: string
        - name: deleteData
          in: query
          description: Also delete all tenant data
          schema:
            type: boolean
            default: false
      responses:
        '200':
          description: Tenant deleted successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MessageResponse'
        '404':
          description: Tenant not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/tenants/{tenantId}/stats:
    get:
      tags:
        - Tenants
      summary: Get tenant statistics
      description: Returns usage statistics for a specific tenant.
      operationId: getTenantStats
      parameters:
        - name: tenantId
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Tenant statistics retrieved
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TenantStats'
        '404':
          description: Tenant not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  # Email Archiving Endpoints
  /api/archive/search:
    get:
      tags:
        - Archive
      summary: Search archived messages
      description: Performs search across archived emails with filtering options.
      operationId: searchArchive
      parameters:
        - name: q
          in: query
          description: Full-text search query
          schema:
            type: string
        - name: tenant_id
          in: query
          description: Filter by tenant
          schema:
            type: integer
        - name: user_email
          in: query
          description: Filter by user email
          schema:
            type: string
        - name: sender
          in: query
          description: Filter by sender
          schema:
            type: string
        - name: from_date
          in: query
          description: Filter messages after this Unix timestamp
          schema:
            type: integer
            format: int64
        - name: to_date
          in: query
          description: Filter messages before this Unix timestamp
          schema:
            type: integer
            format: int64
        - name: legal_hold_only
          in: query
          description: Only return messages under legal hold
          schema:
            type: boolean
        - name: limit
          in: query
          description: Maximum results (default 100, max 1000)
          schema:
            type: integer
            default: 100
        - name: offset
          in: query
          description: Pagination offset
          schema:
            type: integer
            default: 0
      responses:
        '200':
          description: Archive search results
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ArchiveSearchResponse'

  /api/archive/stats:
    get:
      tags:
        - Archive
      summary: Get archive statistics
      description: Returns overall archive statistics.
      operationId: getArchiveStats
      responses:
        '200':
          description: Archive statistics
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ArchiveStats'

  /api/archive/retention-policies:
    get:
      tags:
        - Archive
      summary: List retention policies
      description: Returns all configured retention policies.
      operationId: listRetentionPolicies
      responses:
        '200':
          description: Retention policies list
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RetentionPolicyListResponse'

    post:
      tags:
        - Archive
      summary: Create retention policy
      description: Creates a new email retention policy.
      operationId: createRetentionPolicy
      security:
        - csrfToken: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateRetentionPolicyRequest'
      responses:
        '201':
          description: Policy created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RetentionPolicy'
        '400':
          description: Invalid policy configuration
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/archive/retention-policies/{policyId}:
    delete:
      tags:
        - Archive
      summary: Delete retention policy
      description: Deletes a retention policy.
      operationId: deleteRetentionPolicy
      security:
        - csrfToken: []
      parameters:
        - name: policyId
          in: path
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: Policy deleted successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MessageResponse'
        '404':
          description: Policy not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/archive/legal-holds:
    get:
      tags:
        - Archive
      summary: List legal holds
      description: Returns all legal holds (active and released).
      operationId: listLegalHolds
      parameters:
        - name: status
          in: query
          description: Filter by status
          schema:
            type: string
            enum: [active, released, expired, pending]
      responses:
        '200':
          description: Legal holds list
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/LegalHoldListResponse'

    post:
      tags:
        - Archive
      summary: Create legal hold
      description: Creates a new legal hold to preserve emails for compliance.
      operationId: createLegalHold
      security:
        - csrfToken: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateLegalHoldRequest'
      responses:
        '201':
          description: Legal hold created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/LegalHold'
        '400':
          description: Invalid hold configuration
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/archive/legal-holds/{holdId}:
    get:
      tags:
        - Archive
      summary: Get legal hold details
      description: Returns detailed information about a legal hold.
      operationId: getLegalHold
      parameters:
        - name: holdId
          in: path
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: Legal hold details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/LegalHold'
        '404':
          description: Legal hold not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

    delete:
      tags:
        - Archive
      summary: Release legal hold
      description: Releases a legal hold, allowing normal retention policies to apply.
      operationId: releaseLegalHold
      security:
        - csrfToken: []
      parameters:
        - name: holdId
          in: path
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: Legal hold released
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MessageResponse'
        '404':
          description: Legal hold not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/archive/export:
    post:
      tags:
        - Archive
      summary: Create export job
      description: Creates a new archive export job for downloading emails.
      operationId: createExportJob
      security:
        - csrfToken: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateExportJobRequest'
      responses:
        '201':
          description: Export job created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ExportJob'
        '400':
          description: Invalid export configuration
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/archive/export/{jobId}:
    get:
      tags:
        - Archive
      summary: Get export job status
      description: Returns the status of an export job.
      operationId: getExportJobStatus
      parameters:
        - name: jobId
          in: path
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: Export job status
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ExportJob'
        '404':
          description: Export job not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

    delete:
      tags:
        - Archive
      summary: Cancel export job
      description: Cancels a running or pending export job.
      operationId: cancelExportJob
      security:
        - csrfToken: []
      parameters:
        - name: jobId
          in: path
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: Export job cancelled
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MessageResponse'
        '404':
          description: Export job not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/archive/export/{jobId}/download:
    get:
      tags:
        - Archive
      summary: Download export file
      description: Downloads the completed export file.
      operationId: downloadExport
      parameters:
        - name: jobId
          in: path
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: Export file download
          content:
            application/octet-stream:
              schema:
                type: string
                format: binary
        '404':
          description: Export not found or not ready
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

components:
  securitySchemes:
    csrfToken:
      type: apiKey
      in: header
      name: X-CSRF-Token
      description: CSRF token obtained from GET /api/csrf-token

  schemas:
    ErrorResponse:
      type: object
      required: [error]
      properties:
        error:
          type: string
          description: Error message

    MessageResponse:
      type: object
      required: [message]
      properties:
        message:
          type: string
        username:
          type: string

    CSRFTokenResponse:
      type: object
      required: [token]
      properties:
        token:
          type: string
          description: CSRF token to include in X-CSRF-Token header

    User:
      type: object
      required: [username, email, enabled, created_at, last_login]
      properties:
        username:
          type: string
        email:
          type: string
          format: email
        enabled:
          type: boolean
        created_at:
          type: integer
          format: int64
          description: Unix timestamp
        last_login:
          type: integer
          format: int64
          description: Unix timestamp (0 if never)

    UserListResponse:
      type: object
      required: [users, count]
      properties:
        users:
          type: array
          items:
            $ref: '#/components/schemas/User'
        count:
          type: integer

    CreateUserRequest:
      type: object
      required: [username, email, password]
      properties:
        username:
          type: string
          minLength: 3
          maxLength: 64
        email:
          type: string
          format: email
        password:
          type: string
          minLength: 8

    CreateUserResponse:
      type: object
      required: [message, username, email]
      properties:
        message:
          type: string
        username:
          type: string
        email:
          type: string

    UpdateUserRequest:
      type: object
      properties:
        email:
          type: string
          format: email
        password:
          type: string
          minLength: 8
        enabled:
          type: string
          enum: ["true", "false"]

    StatsResponse:
      type: object
      required: [server, queue, users]
      properties:
        server:
          type: object
          properties:
            status:
              type: string
              enum: [running, stopping]
            version:
              type: string
        queue:
          $ref: '#/components/schemas/QueueStatus'
        users:
          type: object
          properties:
            total:
              type: integer

    QueueStatus:
      type: object
      required: [total, pending, processing, retry]
      properties:
        total:
          type: integer
        pending:
          type: integer
        processing:
          type: integer
        retry:
          type: integer

    Filter:
      type: object
      required: [name, enabled, action]
      properties:
        name:
          type: string
        enabled:
          type: boolean
        action:
          type: string
          enum: [accept, reject, forward, discard, tag]

    FilterListResponse:
      type: object
      required: [filters]
      properties:
        filters:
          type: array
          items:
            $ref: '#/components/schemas/Filter'

    CreateFilterRequest:
      type: object
      required: [name, conditions, action]
      properties:
        name:
          type: string
        conditions:
          type: array
          items:
            type: object
            properties:
              type:
                type: string
                enum: [from, to, subject, header, body, size, attachments]
              value:
                type: string
        action:
          type: string
          enum: [accept, reject, forward, discard, tag]

    SearchResult:
      type: object
      properties:
        id:
          type: integer
          format: int64
        message_id:
          type: string
        email:
          type: string
        sender:
          type: string
        subject:
          type: string
        snippet:
          type: string
        received_at:
          type: integer
          format: int64
        size:
          type: integer
        folder:
          type: string
        relevance:
          type: number
          format: float

    SearchResponse:
      type: object
      required: [results, count]
      properties:
        results:
          type: array
          items:
            $ref: '#/components/schemas/SearchResult'
        count:
          type: integer

    SearchStats:
      type: object
      properties:
        total_messages:
          type: integer
        total_size:
          type: integer
          format: int64
        unique_senders:
          type: integer
        total_folders:
          type: integer
        oldest_message:
          type: integer
          format: int64
        newest_message:
          type: integer
          format: int64
        fts_enabled:
          type: boolean

    ConfigResponse:
      type: object
      required: [config]
      properties:
        config:
          type: object
          additionalProperties:
            type: string

    LogsResponse:
      type: object
      required: [logs, count]
      properties:
        logs:
          type: array
          items:
            type: string
        count:
          type: integer

    AuditEntry:
      type: object
      required: [id, timestamp, action, actor, severity]
      properties:
        id:
          type: integer
          format: int64
        timestamp:
          type: integer
          format: int64
        action:
          type: string
        actor:
          type: string
        target:
          type: string
        target_type:
          type: string
        ip_address:
          type: string
        details:
          type: object
        severity:
          type: string
          enum: [INFO, WARNING, IMPORTANT, CRITICAL]

    AuditResponse:
      type: object
      required: [entries, count, total, limit, offset]
      properties:
        entries:
          type: array
          items:
            $ref: '#/components/schemas/AuditEntry'
        count:
          type: integer
        total:
          type: integer
        limit:
          type: integer
        offset:
          type: integer

    GraphQLRequest:
      type: object
      required: [query]
      properties:
        query:
          type: string
        variables:
          type: object
          additionalProperties: true

    GraphQLResponse:
      type: object
      properties:
        data:
          type: object
          additionalProperties: true
        errors:
          type: array
          items:
            type: object
            properties:
              message:
                type: string

    HealthResponse:
      type: object
      required: [status]
      properties:
        status:
          type: string
          enum: [healthy, degraded, unhealthy]
        uptime:
          type: integer
        connections:
          type: object
          properties:
            active:
              type: integer
            total:
              type: integer
        dependencies:
          type: object
          properties:
            database:
              type: object
              properties:
                status:
                  type: string
                response_time_ms:
                  type: integer
            filesystem:
              type: object
              properties:
                status:
                  type: string
                writable:
                  type: boolean

    # Multi-tenancy Schemas
    Tenant:
      type: object
      required: [id, name, domain, enabled]
      properties:
        id:
          type: integer
          format: int64
        name:
          type: string
        domain:
          type: string
        enabled:
          type: boolean
        created_at:
          type: integer
          format: int64
        settings:
          $ref: '#/components/schemas/TenantSettings'

    TenantSettings:
      type: object
      properties:
        max_users:
          type: integer
        max_storage_gb:
          type: integer
        max_message_size_mb:
          type: integer
        rate_limit_per_minute:
          type: integer
        features:
          type: array
          items:
            type: string

    TenantListResponse:
      type: object
      required: [tenants, count]
      properties:
        tenants:
          type: array
          items:
            $ref: '#/components/schemas/Tenant'
        count:
          type: integer

    CreateTenantRequest:
      type: object
      required: [name, domain]
      properties:
        name:
          type: string
          minLength: 1
          maxLength: 255
        domain:
          type: string
        settings:
          $ref: '#/components/schemas/TenantSettings'

    UpdateTenantRequest:
      type: object
      properties:
        name:
          type: string
        enabled:
          type: boolean
        settings:
          $ref: '#/components/schemas/TenantSettings'

    TenantStats:
      type: object
      properties:
        tenant_id:
          type: integer
          format: int64
        user_count:
          type: integer
        storage_used_bytes:
          type: integer
          format: int64
        message_count:
          type: integer
          format: int64
        messages_today:
          type: integer
        active_connections:
          type: integer

    # Email Archiving Schemas
    ArchivedMessage:
      type: object
      properties:
        id:
          type: integer
          format: int64
        message_id:
          type: string
        tenant_id:
          type: integer
          format: int64
        user_email:
          type: string
        sender:
          type: string
        recipients:
          type: string
        subject:
          type: string
        received_at:
          type: integer
          format: int64
        archived_at:
          type: integer
          format: int64
        folder:
          type: string
        size:
          type: integer
          format: int64
        has_attachments:
          type: boolean
        legal_hold:
          type: boolean

    ArchiveSearchResponse:
      type: object
      required: [messages, total_count, offset, limit]
      properties:
        messages:
          type: array
          items:
            $ref: '#/components/schemas/ArchivedMessage'
        total_count:
          type: integer
          format: int64
        offset:
          type: integer
        limit:
          type: integer

    ArchiveStats:
      type: object
      properties:
        total_messages:
          type: integer
          format: int64
        total_size:
          type: integer
          format: int64
        compressed_size:
          type: integer
          format: int64
        deduplicated_messages:
          type: integer
          format: int64
        active_legal_holds:
          type: integer
        messages_under_hold:
          type: integer
          format: int64
        pending_deletions:
          type: integer
          format: int64

    RetentionPolicy:
      type: object
      required: [id, name, retention_days, expiry_action, enabled]
      properties:
        id:
          type: integer
          format: int64
        name:
          type: string
        tenant_id:
          type: integer
          format: int64
          nullable: true
        retention_days:
          type: integer
        expiry_action:
          type: string
          enum: [delete, archive_only, move_to_cold_storage, notify_admin]
        folders:
          type: array
          items:
            type: string
        priority:
          type: integer
        enabled:
          type: boolean

    RetentionPolicyListResponse:
      type: object
      required: [policies, count]
      properties:
        policies:
          type: array
          items:
            $ref: '#/components/schemas/RetentionPolicy'
        count:
          type: integer

    CreateRetentionPolicyRequest:
      type: object
      required: [name, retention_days, expiry_action]
      properties:
        name:
          type: string
        tenant_id:
          type: integer
          format: int64
        retention_days:
          type: integer
          minimum: 0
        expiry_action:
          type: string
          enum: [delete, archive_only, move_to_cold_storage, notify_admin]
        folders:
          type: array
          items:
            type: string
        priority:
          type: integer
          default: 0

    LegalHold:
      type: object
      required: [id, matter_id, name, custodians, status, created_at, created_by]
      properties:
        id:
          type: integer
          format: int64
        matter_id:
          type: string
        name:
          type: string
        description:
          type: string
        custodians:
          type: array
          items:
            type: string
        start_date:
          type: integer
          format: int64
          nullable: true
        end_date:
          type: integer
          format: int64
          nullable: true
        search_query:
          type: string
        status:
          type: string
          enum: [active, released, expired, pending]
        created_at:
          type: integer
          format: int64
        created_by:
          type: string
        expires_at:
          type: integer
          format: int64
          nullable: true
        message_count:
          type: integer
          format: int64
        total_size:
          type: integer
          format: int64

    LegalHoldListResponse:
      type: object
      required: [holds, count]
      properties:
        holds:
          type: array
          items:
            $ref: '#/components/schemas/LegalHold'
        count:
          type: integer

    CreateLegalHoldRequest:
      type: object
      required: [matter_id, name, custodians]
      properties:
        matter_id:
          type: string
        name:
          type: string
        description:
          type: string
        custodians:
          type: array
          items:
            type: string
          minItems: 1
        start_date:
          type: integer
          format: int64
        end_date:
          type: integer
          format: int64
        search_query:
          type: string
        expires_at:
          type: integer
          format: int64

    ExportJob:
      type: object
      required: [id, status, format, created_at]
      properties:
        id:
          type: integer
          format: int64
        status:
          type: string
          enum: [pending, running, completed, failed, cancelled]
        format:
          type: string
          enum: [mbox, pst, eml, emlx, json]
        progress:
          type: integer
          minimum: 0
          maximum: 100
        messages_processed:
          type: integer
          format: int64
        total_messages:
          type: integer
          format: int64
        output_size:
          type: integer
          format: int64
        created_at:
          type: integer
          format: int64
        started_at:
          type: integer
          format: int64
          nullable: true
        completed_at:
          type: integer
          format: int64
          nullable: true
        error_message:
          type: string
          nullable: true

    CreateExportJobRequest:
      type: object
      required: [format]
      properties:
        format:
          type: string
          enum: [mbox, pst, eml, emlx, json]
        query:
          type: string
        tenant_id:
          type: integer
          format: int64
        user_email:
          type: string
        from_date:
          type: integer
          format: int64
        to_date:
          type: integer
          format: int64
        include_attachments:
          type: boolean
          default: true
        compress:
          type: boolean
          default: true
