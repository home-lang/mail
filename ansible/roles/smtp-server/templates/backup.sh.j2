#!/bin/bash
# SMTP Server Backup Script
# Generated by Ansible

set -e

BACKUP_DIR="{{ backup_dir }}"
TIMESTAMP=$(date +%Y%m%d_%H%M%S)
BACKUP_NAME="smtp-backup-${TIMESTAMP}"
BACKUP_PATH="${BACKUP_DIR}/${BACKUP_NAME}"

# Create backup directory
mkdir -p "${BACKUP_PATH}"

# Backup database
echo "Backing up database..."
sqlite3 {{ db_path }} ".backup ${BACKUP_PATH}/smtp.db"

# Backup mail data
echo "Backing up mail data..."
tar -czf "${BACKUP_PATH}/mail.tar.gz" -C {{ mail_dir }} .

# Backup queue
echo "Backing up queue..."
tar -czf "${BACKUP_PATH}/queue.tar.gz" -C {{ queue_dir }} .

# Create checksum
echo "Creating checksum..."
cd "${BACKUP_PATH}"
sha256sum * > checksums.sha256

# Create metadata
cat > metadata.json <<EOF
{
  "timestamp": "${TIMESTAMP}",
  "hostname": "{{ smtp_hostname }}",
  "version": "{{ smtp_version }}"
}
EOF

echo "Backup completed: ${BACKUP_PATH}"
